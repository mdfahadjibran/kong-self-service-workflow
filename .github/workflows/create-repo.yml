name: Create Kong Repository

on:
  workflow_dispatch:
    inputs:
      repository_name:
        description: "Name of the new Kong repository"
        required: true

permissions:
  contents: write

jobs:
  create-repo:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout self-service repo
        uses: actions/checkout@v4

      - name: Install GitHub CLI
        run: |
          sudo apt update
          sudo apt install gh -y

      # ðŸ”¹ Authenticate using ADMIN PAT (for repo creation)
      - name: Authenticate with Admin PAT
        run: echo "${{ secrets.GH_ADMIN_PAT }}" | gh auth login --with-token

      - name: Create repository if not exists
        run: |
          REPO=${{ github.repository_owner }}/${{ github.event.inputs.repository_name }}

          echo "Checking if $REPO exists..."

          if gh repo view "$REPO" >/dev/null 2>&1; then
            echo "Repository already exists."
          else
            echo "Creating repository $REPO"
            gh repo create "$REPO" --private
          fi

      # ðŸ”¹ Switch to GITHUB_TOKEN for repo operations
      - name: Authenticate with GITHUB_TOKEN
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Bootstrap repository
        run: |
          REPO=${{ github.repository_owner }}/${{ github.event.inputs.repository_name }}
          DIR=${{ github.event.inputs.repository_name }}

          echo "Preparing local repository..."

          rm -rf "$DIR"
          mkdir "$DIR"
          cd "$DIR"

          git init
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/$REPO.git

          mkdir -p .github/workflows
          mkdir -p api

          cp "$GITHUB_WORKSPACE/templates/.github/workflows/kong-deploy.yml" .github/workflows/
          cp "$GITHUB_WORKSPACE/templates/api/kong.yaml" api/

          git add .
          git commit -m "Initial Kong repo structure"

          echo "Creating dev branch..."
          git branch -M dev
          git push -u origin dev

          echo "Creating uat branch..."
          git checkout -b uat
          git push -u origin uat

          echo "Creating prod branch..."
          git checkout -b prod
          git push -u origin prod
